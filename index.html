<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Flux Browser</title>
    <style>
      body {
        margin: 0;
        background: #0f0f14;
        color: white;
        font-family: system-ui, sans-serif;
      }

      #tabs {
        display: flex;
        background: #14141c;
        padding: 6px;
        gap: 6px;
      }

      .tab {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        background: #1e1e26;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        user-select: none;
        cursor: grab;
      }

      .tab.active {
        background: #2b2b38;
      }

      .tab .close {
        opacity: 0.6;
        font-weight: bold;
        cursor: pointer;
      }
      .tab .close:hover {
        opacity: 1;
      }

      .tab.dragging {
        opacity: 0.5;
        cursor: grabbing;
      }

      #toolbar {
        display: flex;
        gap: 8px;
        padding: 8px;
        background: #16161d;
        align-items: center;
      }

      button {
        background: #222;
        color: white;
        border: none;
        padding: 6px 10px;
        cursor: pointer;
        border-radius: 6px;
      }

      input {
        flex: 1;
        padding: 6px 10px;
        border-radius: 6px;
        border: none;
        outline: none;
        background: #1e1e26;
        color: white;
      }

      webview {
        width: 100%;
        height: calc(100vh - 96px);
        display: none;
      }

      webview.active {
        display: flex;
      }
    </style>
  </head>
  <body>

    <div id="tabs">
      <button onclick="newTab()">+</button>
      <button onclick="newTab('https://www.google.com', true)">üïµÔ∏è</button>
    </div>

    <div id="toolbar">
      <button onclick="goBack()">‚óÄ</button>
      <button onclick="goForward()">‚ñ∂</button>
      <button onclick="reload()">‚ü≥</button>
      <input id="url" />
      <button onclick="navigate()">Go</button>
    </div>

    <div id="views"></div>

    <script>
      const tabsBar = document.getElementById("tabs");
      const views = document.getElementById("views");
      const urlInput = document.getElementById("url");
      const FIXED_TAB_BUTTONS = 2; // + and incognito

      urlInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") navigate();
      });

      let tabs = [];
      let activeTab = null;

      function newTab(url = "https://www.google.com", incognito = false) {
        const tabId = Date.now();

        const tabBtn = document.createElement("div");
        tabBtn.className = "tab";
        tabBtn.draggable = true;

        if (incognito) {
          tabBtn.style.opacity = "0.8";
          tabBtn.style.border = "1px dashed rgba(139,92,246,0.4)";
        }

        const titleSpan = document.createElement("span");
        titleSpan.textContent = "New Tab";

        const closeBtn = document.createElement("span");
        closeBtn.textContent = "x";
        closeBtn.className = "close";

        closeBtn.onclick = (e) => {
          e.stopPropagation();
          closeTab(tabId);
        };

        tabBtn.onclick = () => switchTab(tabId);

        tabBtn.appendChild(titleSpan);
        tabBtn.appendChild(closeBtn);
        
        const webview = document.createElement("webview");

        if (incognito) {
          webview.setAttribute(
            "partition",
            "persist:incognito-" + tabId
          );
        }

        webview.src = url;

        webview.addEventListener("page-title-updated", (e) => {
          titleSpan.textContent = e.title.slice(0, 15);
        });

        webview.addEventListener("did-navigate", (e) => {
          if (activeTab === tabId) urlInput.value = e.url;
        });

        webview.addEventListener("did-navigate-in-page", (e) => {
          if (activeTab === tabId) urlInput.value = e.url;
        });

        tabs.push({ id: tabId, tabBtn, webview });
        tabsBar.appendChild(tabBtn)
        views.appendChild(webview);

        switchTab(tabId);
      }

      function switchTab(id) {
        tabs.forEach(t => {
          t.tabBtn.classList.remove("active");
          t.webview.classList.remove("active");
        });

        const tab = tabs.find(t => t.id === id);
        if (!tab) return;

        tab.tabBtn.classList.add("active");
        tab.webview.classList.add("active");
        activeTab = id;
        urlInput.value = tab.webview.getURL();
      }

      function navigate() {
        const tab = tabs.find(t => t.id === activeTab);
        let url = urlInput.value.trim();
        if (!url.startsWith("http")) url = "https://" + url;
        tab.webview.loadURL(url);
      }

      function goBack() {
        const tab = tabs.find(t => t.id === activeTab);
        if (tab.webview.canGoBack()) tab.webview.goBack();
      }

      function goForward() {
        const tab = tabs.find(t => t.id === activeTab);
        if (tab.webview.canGoForward()) tab.webview.goForward();
      }

      function reload() {
        const tab = tabs.find(t => t.id === activeTab);
        tab.webview.reload();
      }

      function closeTab(id) {
        if (tabs.length === 1) return; // üö´ never close last tab

        const index = tabs.findIndex(t => t.id === id);
        if (index === -1) return;

        const tab = tabs[index];

        tab.webview.remove();
        tab.tabBtn.remove();
        tabs.splice(index, 1);

        if (activeTab === id) {
          const nextTab = tabs[index] || tabs[index - 1];
          switchTab(nextTab.id);
        }
      }

      let draggedTabId = null;

      tabsBar.addEventListener("dragstart", (e) => {
        const tabEl = e.target.closest(".tab");
        if (!tabEl) return;

        draggedTabId = tabs.find(t => t.tabBtn === tabEl)?.id;
        tabEl.classList.add("dragging")
      });

      tabsBar.addEventListener("dragend", (e) => {
        const tabEl = e.target.closest(".tab");
        if (tabEl) tabEl.classList.remove("dragging");
        draggedTabId = null;
      });

      tabsBar.addEventListener("dragover", (e) => {
        e.preventDefault();

        const targetTabEl = e.target.closest(".tab");
        if (!targetTabEl || draggedTabId === null) return;

        const draggedIndex = tabs.findIndex(t => t.id === draggedTabId);
        const targetIndex = tabs.findIndex(t => t.tabBtn === targetTabEl);

        if (draggedIndex === -1 || targetIndex === -1) return;
        if (draggedIndex === targetIndex) return;

        // Reorder internal state
        const draggedTab = tabs.splice(draggedIndex, 1)[0];
        tabs.splice(targetIndex, 0, draggedTab);

        // Reorder DOM ‚Äî ALWAYS after fixed buttons
        const referenceNode =
          tabsBar.children[targetIndex + FIXED_TAB_BUTTONS];

        tabsBar.insertBefore(draggedTab.tabBtn, referenceNode || null);
      });


      newTab();
    </script>

  </body>
</html>